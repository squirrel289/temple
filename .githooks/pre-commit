#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook: run tests affected by staged Python files.
# Blocks the commit if affected tests fail.

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

echo "Running pre-commit: affected-tests"

PYTHON=python
if [[ -x "$(pwd)/.hooks-venv/bin/python" ]]; then
  PYTHON="$(pwd)/.hooks-venv/bin/python"
else
  if command -v python >/dev/null 2>&1; then
    PYTHON=python
  elif command -v python3 >/dev/null 2>&1; then
    PYTHON=python3
  else
    echo "python not found in PATH; skipping test checks (allowing commit)." >&2
    exit 0
  fi
fi

# Get staged python files
STAGED_FILES=$(git diff --name-only --cached --relative -- '*.py' || true)
if [[ -z "$STAGED_FILES" ]]; then
  echo "No staged Python files; skipping tests."
  exit 0
fi

# Run ruff checks (no autofix) on staged Python files to prevent accidental
# formatting changes from being committed by editor auto-formatters. This runs
# `ruff check` (no `--fix`) and fails the commit if violations are found.
if command -v ruff >/dev/null 2>&1; then
  echo "Running ruff check on staged files"
  ruff check $STAGED_FILES || {
    echo "Ruff found issues. Run 'ruff check' to see details or 'ruff format' locally to fix.'" >&2
    exit 1
  }
else
  echo "ruff not installed; skipping ruff checks"
fi

# Build pytest -k pattern from basenames (without extension)
patterns=()
while IFS= read -r f; do
  base="$(basename "$f" .py)"
  patterns+=("$base")
done <<< "$STAGED_FILES"

# Deduplicate
IFS=$'\n' read -r -d '' -a uniq_patterns < <(printf "%s\n" "${patterns[@]}" | awk '!seen[$0]++' && printf '\0')

K_EXPR=""
for p in "${uniq_patterns[@]}"; do
  if [[ -z "$K_EXPR" ]]; then
    K_EXPR="$p"
  else
    K_EXPR="$K_EXPR or $p"
  fi
done

echo "Running pytest for changed modules: $K_EXPR"
"$PYTHON" -m pytest -q -k "$K_EXPR" --maxfail=1 --disable-warnings

echo "Pre-commit checks passed."
exit 0
