---
name: ASV Benchmarks Publish

"on":
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  run-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Ensure needed git history for ASV
        run: |
          if git rev-parse --verify HEAD~4 >/dev/null 2>&1; then
            echo "Sufficient history present"
            exit 0
          fi
          git fetch --depth=10 origin || true
          if git rev-parse --verify HEAD~4 >/dev/null 2>&1; then
            exit 0
          fi
          git fetch --unshallow || true
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        run: pip install uv
      - name: Cache uv packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('temple/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-uv-
      - name: Install dependencies
        run: |
          cd temple
          uv pip install ".[bench]"
      - name: Collect runner info
        run: |
          mkdir -p .github
          hostname > .github/runner_info.txt || true
          uname -a >> .github/runner_info.txt || true
          lscpu >> .github/runner_info.txt || true
          free -h >> .github/runner_info.txt || true
      - name: Upload pre-ASV results snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre_asv_results
          path: |
            temple/asv/results
            .github/runner_info.txt
      - name: Configure deterministic CI machine identity
        run: |
          bash .github/scripts/configure_asv_machine.sh asv/machines/ci_machine.json || true
      - name: Run ASV benchmarks
        continue-on-error: true
        run: |
          cd temple
          uv pip run asv update || true
          uv pip run asv run --quick HEAD~4..HEAD || true
          uv pip run asv run --quick HEAD || true
      - name: Generate ASV HTML report
        run: |
          cd temple
          uv pip run asv publish
      - name: Prepare versioned publish directory
        working-directory: temple
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          PUBLISH_DIR=asv_publish/${TIMESTAMP}
          mkdir -p ${PUBLISH_DIR}
          if [ -d asv/results/html ]; then
            rsync -a asv/results/html/ ${PUBLISH_DIR}/html/
          fi
          if [ -d asv/results ]; then
            rsync -a asv/results/ ${PUBLISH_DIR}/raw/
          fi
      - name: Upload ASV results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asv_results
          path: temple/asv/results
      - name: Upload HTML for Pages deployment
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./temple/asv/results/html

  deploy-pages:
    needs: run-and-publish
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
