name: ASV Benchmarks Publish

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1'  # weekly on Monday at 04:00 UTC

jobs:
  run-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install asv==0.6.5

      - name: Patch asv version-compare bug (temporary)
        run: |
            python .github/scripts/patch_asv_version.py || true

      - name: Prepare deterministic CI machine identity
        run: |
          # Copy checked-in sanitized machine JSON into asv_results so ASV recognizes this machine
          mkdir -p asv_results/temple-ci-gh-actions
          cp asv_machines/ci_machine.json asv_results/temple-ci-gh-actions/machine.json

      - name: Collect runner info
        run: |
          hostname > .github/runner_info.txt || true
          uname -a >> .github/runner_info.txt || true
          lscpu >> .github/runner_info.txt || true
          free -h >> .github/runner_info.txt || true

      - name: Upload pre-ASV results snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre_asv_results
          path: |
            asv_results
            .github/runner_info.txt

      - name: Run ASV benchmarks
        continue-on-error: true
        run: |
          # Ensure the deterministic (hex) machine JSON is present in results so ASV
          # recognizes the CI runner as a stable machine and avoids fragmented history.
          DETERMINISTIC_ID=2b167144ba2b
          mkdir -p asv_results/${DETERMINISTIC_ID}
          if [ -f asv_machines/2b167144ba2b_machine.json ]; then
            cp asv_machines/2b167144ba2b_machine.json asv_results/${DETERMINISTIC_ID}/machine.json
            echo "Copied deterministic machine JSON into asv_results/${DETERMINISTIC_ID}/machine.json"
          else
            echo "ERROR: deterministic machine JSON not found at asv_machines/2b167144ba2b_machine.json" >&2
            exit 1
          fi
          # Ensure ASV config is up-to-date, then run benchmarks non-interactively
          asv update || true
          # Ensure ASV has a machine record (create non-interactively by
          # piping the checked-in sanitized machine JSON). This avoids prompts
          # and creates a machine.json we can capture.
          python - <<'PY' | asv machine --yes || true
import json, sys
data = json.load(open('asv_machines/ci_machine.json'))
sys.stdout.write(data.get('machine','') + "\n")
sys.stdout.write(data.get('os','') + "\n")
sys.stdout.write(data.get('arch','') + "\n")
sys.stdout.write(data.get('cpu','') + "\n")
sys.stdout.write(str(data.get('num_cpu','')) + "\n")
sys.stdout.write(str(data.get('ram','')) + "\n")
PY
          asv run --quick --machine "${DETERMINISTIC_ID}"

      - name: Prepare versioned publish directory
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          PUBLISH_DIR=asv_publish/${TIMESTAMP}
          mkdir -p ${PUBLISH_DIR}
          if [ -d asv_results/html ]; then
            rsync -a asv_results/html/ ${PUBLISH_DIR}/html/
          fi
          if [ -d asv_results ]; then
            rsync -a asv_results/ ${PUBLISH_DIR}/raw/
          fi

      - name: Upload ASV results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asv_results
          path: asv_results

      - name: Publish ASV HTML to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./asv_publish
          publish_branch: gh-pages
