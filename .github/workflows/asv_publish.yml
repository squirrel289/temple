name: ASV Benchmarks Publish

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1'  # weekly on Monday at 04:00 UTC

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  run-and-publish:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install asv==0.6.5
          pip install -e .

      - name: Patch asv version-compare bug (temporary)
        run: |
            python .github/scripts/patch_asv_version.py || true

      - name: Prepare deterministic CI machine identity
        run: |
          # Copy checked-in sanitized machine JSON into asv_results so ASV recognizes this machine
          mkdir -p asv_results/temple-ci-gh-actions
          cp asv_machines/ci_machine.json asv_results/temple-ci-gh-actions/machine.json

      - name: Collect runner info
        run: |
          hostname > .github/runner_info.txt || true
          uname -a >> .github/runner_info.txt || true
          lscpu >> .github/runner_info.txt || true
          free -h >> .github/runner_info.txt || true

      - name: Upload pre-ASV results snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre_asv_results
          path: |
            asv_results
            .github/runner_info.txt

      - name: Run ASV benchmarks
        continue-on-error: true
        run: |
          # Create ~/.asv-machine.json mapping the runner hostname to a checked-in
          # machine JSON (prefer host-specific, then ci_machine.json, then deterministic fallback).
            HOSTNAME=$(hostname)
            SRC=''
            if [ -f "asv_machines/${HOSTNAME}_machine.json" ]; then
              SRC="asv_machines/${HOSTNAME}_machine.json"
            elif [ -f asv_machines/ci_machine.json ]; then
              SRC="asv_machines/ci_machine.json"
            elif [ -f asv_machines/2b167144ba2b_machine.json ]; then
              SRC="asv_machines/2b167144ba2b_machine.json"
            fi
            if [ -n "$SRC" ]; then
              # Build a JSON object with the runner hostname as a quoted key.
              # Write mapping and include a version key so asv can parse the file.
              echo -n '{' > ~/.asv-machine.json
              printf '%s' "\"$HOSTNAME\"" >> ~/.asv-machine.json
              echo -n ':' >> ~/.asv-machine.json
              cat "$SRC" >> ~/.asv-machine.json
              echo -n ",\"version\": 1}" >> ~/.asv-machine.json
              MNAME=$(grep -m1 '"machine"' "$SRC" | sed -E "s/.*:\\s*\"([^\"]+)\".*/\\1/")
              if [ -z "$MNAME" ]; then
                MNAME="$HOSTNAME"
              fi
              mkdir -p "asv_results/$MNAME"
              cp "$SRC" "asv_results/$MNAME/machine.json"
              echo "Wrote ~/.asv-machine.json and asv_results/$MNAME/machine.json"
            else
              echo "No checked-in machine json found; ASV may prompt interactively"
            fi

          # Update ASV and run benchmarks. If ~/.asv-machine.json contains the
          # host entry ASV should not prompt interactively.
          asv update || true
          # Run on last 5 commits to populate graphs with historical data
          asv run --quick HEAD~4..HEAD || true
          # Also run current HEAD if not already covered
          asv run --quick HEAD || true

      - name: Generate ASV HTML report
        run: |
          # Publish benchmark results to HTML
          asv publish

      - name: Prepare versioned publish directory
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          PUBLISH_DIR=asv_publish/${TIMESTAMP}
          mkdir -p ${PUBLISH_DIR}
          if [ -d asv_results/html ]; then
            rsync -a asv_results/html/ ${PUBLISH_DIR}/html/
          fi
          if [ -d asv_results ]; then
            rsync -a asv_results/ ${PUBLISH_DIR}/raw/
          fi

      - name: Upload ASV results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asv_results
          path: asv_results

      - name: Upload HTML for Pages deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./asv_results/html

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
