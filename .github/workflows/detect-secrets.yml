---
name: Detect secrets

on:
  pull_request:
  push:
    branches: [main]

jobs:
  scan:
    name: Scan for secrets
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set-status.outputs.status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        run: pip install uv
      - name: Cache uv packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-detect-secrets
          restore-keys: ${{ runner.os }}-uv-
      - name: Install detect-secrets
        run: uv pip install detect-secrets PyYAML
      - name: Compare with committed baseline
        id: compare
        run: |
          set -euo pipefail
          set +e
          uv pip run detect-secrets scan --all-files > detect_secrets_curr.json 2>&1
          rc=$?
          set -e
          if [ "$rc" -ne 0 ]; then
            echo "new" > detect_secrets_status.txt
          else
            echo "ok" > detect_secrets_status.txt
          fi
      - name: Upload scan artifact
        uses: actions/upload-artifact@v4
        with:
          name: detect-secrets-curr
          path: detect_secrets_curr.json
      - name: Upload baseline snapshot
        uses: actions/upload-artifact@v4
        with:
          name: current-baseline
          path: current.baseline
          if-no-files-found: ignore
      - name: Set job output status
        id: set-status
        run: |
          if [ -f detect_secrets_status.txt ]; then
            status=$(cat detect_secrets_status.txt)
          else
            status=ok
          fi
          echo "status=$status" >> $GITHUB_OUTPUT

  propose-baseline:
    name: Propose baseline update
    needs: scan
    runs-on: ubuntu-latest
    if: needs.scan.outputs.status != 'ok'
    steps:
      - name: Ensure automation token configured

        run: |
          if [ -z "${{ secrets.DETECT_SECRETS_BOT_TOKEN }}" ]; then
              echo "No DETECT_SECRETS_BOT_TOKEN; skipping PR" >&2
            echo "baseline PR creation." >&2
            exit 78
          fi

      - name: Checkout (automation token)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.DETECT_SECRETS_BOT_TOKEN }}

      - name: Download baseline snapshot
        uses: actions/download-artifact@v4
        with:
          name: current-baseline

      - name: Prepare baseline update
        run: |
          if [ ! -f current.baseline ]; then
            echo "current.baseline missing" >&2
            exit 1
          fi
          cp current.baseline .secrets.baseline
          git config user.name "detect-secrets-bot"
          git config user.email "ci-bot@example.com"
          branch="chore/detect-secrets/baseline-update-$(date +%s)"
          git checkout -b "$branch"
          git add .secrets.baseline
          if git diff --staged --quiet; then
            echo "No changes to baseline; skipping PR creation"
            exit 0
          fi
          git commit -m "chore(secrets): update .secrets.baseline (automated)"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.DETECT_SECRETS_BOT_TOKEN }}
          commit-message: "chore(secrets): update .secrets.baseline (automated)"
          title: "chore(secrets): update .secrets.baseline (automated)"
          body: |
            Automated update to the `.secrets.baseline`.
            Generated by the detect-secrets scan.
            Please review the proposed baseline and merge if acceptable.
          base: main
          branch: ${{ github.ref }}
