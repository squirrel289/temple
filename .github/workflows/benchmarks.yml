---
name: Benchmarks

"on":
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * 1'
  pull_request:
    branches: [main]
  push:
    branches:
      - main

jobs:
  perf-regression:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        run: pip install uv
      - name: Cache uv packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('temple/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-uv-
      - name: Install dependencies
        run: |
          cd temple
          uv pip install ".[bench]"
      - name: Run quick benchmark gate
        run: |
          cd temple
          uv pip run pytest tests/ -k benchmark --co || true

  benchmarks:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        run: pip install uv
      - name: Cache uv packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('temple/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-uv-
      - name: Install dependencies
        run: |
          cd temple
          uv pip install ".[bench]"
      - name: Prepare ASV machine mapping
        run: |
          HOSTNAME=$(hostname)
          SRC="asv/machines/ci_machine.json"
          mkdir -p temple/asv/results
          if [ -f "$SRC" ]; then
            echo -n '{' > ~/.asv-machine.json
            printf '%s' "\"$HOSTNAME\"" >> ~/.asv-machine.json
            echo -n ':' >> ~/.asv-machine.json
            cat "$SRC" >> ~/.asv-machine.json
            echo -n ",\"version\": 1}" >> ~/.asv-machine.json
            MNAME=$(grep -m1 '"machine"' "$SRC" | sed -E "s/.*:\s*\"([^\"]+)\".*/\1/")
            [ -z "$MNAME" ] && MNAME="$HOSTNAME"
            mkdir -p "temple/asv/results/$MNAME"
            cp "$SRC" "temple/asv/results/$MNAME/machine.json"
          fi
      - name: Run and publish temple benchmarks
        working-directory: temple
        run: |
          uv pip run asv run --quick HEAD || true
          uv pip run asv publish
      - name: Upload ASV results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asv_results_temple
          path: temple/asv/results
