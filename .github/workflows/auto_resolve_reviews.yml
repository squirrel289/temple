---
name: Auto-resolve PR review threads

on:
  pull_request:
    types: [synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  resolve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/ci/requirements-resolver.txt

      - name: (deps installed via requirements)
        run: echo "Dependencies installed from scripts/ci/requirements-resolver.txt"

      - name: Write App private key (REVIEW_RESOLUTION_BOT_APP_KEY)
        env:
          KEY: ${{ secrets.REVIEW_RESOLUTION_BOT_APP_KEY }}
        run: |
          printf "%s" "$KEY" > private-key.pem
          chmod 600 private-key.pem

      - name: Get App installation id (REVIEW_RESOLUTION_BOT_APP_ID)
        env:
          APP_ID: ${{ secrets.REVIEW_RESOLUTION_BOT_APP_ID }}
        run: |
          inst=$(python scripts/ci/github_app_helpers.py --app-id "$APP_ID" --private-key private-key.pem --repo "${{ github.repository }}")
          if [ -z "$inst" ]; then
            echo "No installation found for repository; exiting" >&2
            exit 1
          fi
          echo "INSTALLATION_ID=$inst" >> $GITHUB_ENV

      - name: Create installation token
        if: env.INSTALLATION_ID != ''
        run: |
          APP_ID="${{ secrets.REVIEW_RESOLUTION_BOT_APP_ID }}"
          token=$(python scripts/ci/github_app_helpers.py --app-id "$APP_ID" --private-key private-key.pem --installation ${{ env.INSTALLATION_ID }})
          echo "INSTALL_TOKEN=$token" >> $GITHUB_ENV

      - name: Run auto-resolve (dry-run)
        env:
          REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          GITHUB_PR_AUTORESOLVE_TOKEN: ${{ env.INSTALL_TOKEN || secrets.GITHUB_PR_AUTORESOLVE_TOKEN }}
          DRY_RUN: '1'
        run: |
          python scripts/ci/auto_resolve_reviews.py
